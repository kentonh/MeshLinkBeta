<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Coverage Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/map.css">
    <style>
        /* Additional styles for coverage map */
        .legend-section .legend-subtitle {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .legend-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
            border: 2px solid rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.15);
        }
        .legend-polygon {
            width: 20px;
            height: 14px;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
            background: rgba (136, 136, 136, 0.2);
            border: 2px solid rgba (136, 136, 136, 0.2);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="map-page">
        <!-- Header -->
        <header class="map-header">
            <div class="header-left">
                <h1 id="page-header">Coverage Map</h1>
            </div>
            <div class="header-controls">
                <select id="time-window" class="control-select">
                    <option value="1">Last 1 Hour</option>
                    <option value="6">Last 6 Hours</option>
                    <option value="24" selected>Last 24 Hours</option>
                    <option value="168">Last 7 Days</option>
                    <option value="720">Last 30 Days</option>
                </select>
                <button id="refresh-btn" class="control-btn">Refresh</button>
                <a href="/nodes.html" class="control-btn nav-btn nav-btn-desktop">Nodes</a>
                <a href="/traceroutes.html" class="control-btn nav-btn nav-btn-desktop">Traceroutes</a>
                <a href="/telemetry.html" class="control-btn nav-btn nav-btn-desktop">Telemetry</a>
                <select id="nav-dropdown" class="control-select nav-dropdown-mobile" onchange="if(this.value) window.location.href=this.value">
                    <option value="">Navigate...</option>
                    <option value="/nodes.html">Nodes</option>
                    <option value="/traceroutes.html">Traceroutes</option>
                    <option value="/telemetry.html">Telemetry</option>
                </select>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">Nodes:</span>
                <span id="stat-nodes" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Direct Links:</span>
                <span id="stat-direct" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Indirect Coverage:</span>
                <span id="stat-indirect" class="stat-value">0</span>
            </div>
            <div class="stat-item loading-indicator" id="loading-indicator">
                <span class="spinner"></span>
                <span>Loading...</span>
            </div>
        </div>

        <!-- Map Container -->
        <div id="map-container">
            <div id="map"></div>
        </div>

        <!-- Legend -->
        <div class="map-legend" id="map-legend">
            <div class="legend-section">
                <div class="legend-title">Node Status</div>
                <div class="legend-item">
                    <span class="legend-marker" style="background: #4caf50;"></span>
                    <span>Online (&lt;3 hours)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker" style="background: #8bc34a;"></span>
                    <span>Recent (&lt;12 hours)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker" style="background: #ffc107;"></span>
                    <span>This Week</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker" style="background: #f44336;"></span>
                    <span>Older</span>
                </div>
            </div>
            <div class="legend-section">
                <div class="legend-title">Direct Connections</div>
                <div class="legend-subtitle">Confirmed RF links</div>
                <div class="legend-item">
                    <span class="legend-line" style="background: #09af0f;"></span>
                    <span>Good signal</span>
                </div>
                <div class="legend-item">
                    <span class="legend-line" style="background: #ffc107;"></span>
                    <span>Fair signal</span>
                </div>
                <div class="legend-item">
                    <span class="legend-line" style="background: #f44336;"></span>
                    <span>Poor signal</span>
                </div>
                <div class="legend-item">
                    <span class="legend-line" style="background: #667eea;"></span>
                    <span>Unknown signal</span>
                </div>
            </div>
            <div class="legend-section">
                <div class="legend-title">Indirect Coverage</div>
                <div class="legend-subtitle">Inferred reach (2+ hops)</div>
                <div class="legend-item">
                    <span class="legend-circle"></span>
                    <span>Confirmed Relay Reach</span>
                </div>
                <div class="legend-item">
                    <span class="legend-polygon"></span>
                    <span>Theoretical Mesh Reach</span>
                </div>
            </div>
            <button class="legend-toggle" id="legend-toggle">Hide Legend</button>
        </div>

        <!-- Node Details Panel -->
        <div class="details-panel" id="details-panel">
            <div class="details-header">
                <h3 id="details-title">Node Details</h3>
                <button class="close-btn" id="close-details">&times;</button>
            </div>
            <div class="details-content" id="details-content">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/map.js"></script>
    <script>
        fetch('/api/site-config').then(r => r.json()).then(data => {
            if (data.success && data.botName) {
                document.getElementById('page-title').textContent = data.botName + ' Coverage Map';
                document.getElementById('page-header').textContent = data.botName + ' Coverage Map';
            }
        }).catch(() => {});
    </script>
</body>
</html>
